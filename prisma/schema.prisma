// QaHub Database Schema
// Test Management System with Document Management and Analytics
// Database: PostgreSQL
// ORM: Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// MULTI-TENANCY
// ========================================

enum TenantStatus {
  active
  suspended
  cancelled
  trial
}

enum TenantPlan {
  free
  starter
  professional
  enterprise
}

model Tenant {
  id             BigInt       @id @default(autoincrement()) @db.BigInt
  name           String       @unique @db.VarChar(255)
  slug           String       @unique @db.VarChar(255)
  domain         String?      @unique @map("domain") @db.VarChar(255)
  subdomain      String?      @unique @map("subdomain") @db.VarChar(255)
  plan           TenantPlan   @default(free)
  status         TenantStatus @default(active)
  maxUsers       Int          @default(5) @map("max_users") @db.Integer
  maxProjects    Int          @default(3) @map("max_projects") @db.Integer
  features       Json?        @map("features")
  billingEmail   String?      @map("billing_email") @db.VarChar(255)
  subscriptionId String?      @map("subscription_id") @db.VarChar(255)
  trialEndsAt    DateTime?    @map("trial_ends_at") @db.Timestamp
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamp
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamp

  tenantUsers     TenantUser[]
  projects        Project[]
  repositories    Repository[]
  testCases       TestCase[]
  documents       Document[]
  userInvitations UserInvitation[]

  @@index([slug])
  @@index([domain])
  @@index([subdomain])
  @@index([plan, status])
  @@index([status])
  @@map("tenants")
}

model TenantUser {
  tenantId  BigInt   @map("tenant_id") @db.BigInt
  userId    BigInt   @map("user_id") @db.BigInt
  role      String   @default("member") @db.VarChar(50)
  invitedBy BigInt?  @map("invited_by") @db.BigInt
  joinedAt  DateTime @default(now()) @map("joined_at") @db.Timestamp
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([tenantId, userId])
  @@index([userId, tenantId])
  @@index([tenantId, role])
  @@index([userId])
  @@map("tenant_users")
}

// ========================================
// USER MANAGEMENT & AUTHENTICATION
// ========================================

model User {
  id                BigInt    @id @default(autoincrement()) @db.BigInt
  name              String    @db.VarChar(255)
  email             String    @unique @db.VarChar(100)
  googleId          String?   @unique @map("google_id") @db.VarChar(255)
  googleAvatar      String?   @map("google_avatar") @db.VarChar(500)
  authProvider      String    @default("email") @map("auth_provider") @db.VarChar(50)
  role              String?   @db.VarChar(50)
  avatar            String?   @db.VarChar(500)
  lastLoginAt       DateTime? @map("last_login_at") @db.Timestamp
  passwordChangedAt DateTime? @map("password_changed_at") @db.Timestamp
  isActive          Boolean   @default(true) @map("is_active")
  emailVerifiedAt   DateTime? @map("email_verified_at") @db.Timestamp
  password          String    @db.VarChar(255)
  jobRole           String?   @map("job_role") @db.VarChar(100)
  rememberToken     String?   @map("remember_token") @db.VarChar(100)
  preferences       Json?     @map("preferences")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamp

  tenantUsers             TenantUser[]
  passwordResets          PasswordReset[]
  personalAccessTokens    PersonalAccessToken[]
  passwordHistory         PasswordHistory[]
  userRoles               UserRole[]
  userPermissions         UserPermission[]
  createdProjects         Project[]             @relation("ProjectCreator")
  updatedProjects         Project[]             @relation("ProjectUpdater")
  auditLogs               AuditLog[]
  changeLogs              ChangeLog[]           @relation("ChangeLogChanger")
  sentInvitations         UserInvitation[]      @relation("UserInvitations")
  documentTemplates       DocumentTemplate[]    @relation("DocumentTemplateCreator")
  editorImages            EditorImage[]         @relation("EditorImageUploader")
  menuVisibilitiesCreated MenuVisibility[]      @relation("MenuVisibilityCreator")
  menuVisibilitiesUpdated MenuVisibility[]      @relation("MenuVisibilityUpdater")
  bugBudgetsAssigned      BugBudget[]           @relation("BugBudgetAssignee")
  bugBudgetsReported      BugBudget[]           @relation("BugBudgetReporter")
  bugBudgetsCreated       BugBudget[]           @relation("BugBudgetCreator")
  jiraFieldsCreated       JiraField[]           @relation("JiraFieldCreator")
  jiraFieldsUpdated       JiraField[]           @relation("JiraFieldUpdater")
  decisionLogsOwned       DecisionLog[]         @relation("DecisionLogOwner")
  decisionLogsCreated     DecisionLog[]         @relation("DecisionLogCreator")
  decisionLogsUpdated     DecisionLog[]         @relation("DecisionLogUpdater")
  prdReviewsReviewed      PrdReview[]           @relation("PrdReviewReviewer")
  prdReviewsCreated       PrdReview[]           @relation("PrdReviewCreator")
  prdReviewsUpdated       PrdReview[]           @relation("PrdReviewUpdater")
  auditEvents             AuditEvent[]
  allureReportsCreated    AllureReport[]        @relation("AllureReportCreator")
  allureReportsUpdated    AllureReport[]        @relation("AllureReportUpdater")
  gitlabMrAuthors         GitlabMrLeadTime[]    @relation("GitlabMrAuthor")
  gitlabMrContributors    GitlabMrContributor[] @relation("GitlabMrContributor")
  monthlyContributions    MonthlyContribution[] @relation("MonthlyContributionUser")
  workflowSagasStarted    WorkflowSaga[]        @relation("WorkflowSagaStarter")

  @@index([email])
  @@index([googleId])
  @@map("users")
}

model PasswordReset {
  id        BigInt    @id @default(autoincrement()) @db.BigInt
  email     String    @db.VarChar(255)
  userId    BigInt?   @map("user_id") @db.BigInt
  token     String    @unique @db.VarChar(255)
  usedAt    DateTime? @map("used_at") @db.Timestamp
  expiresAt DateTime? @map("expires_at") @db.Timestamp
  createdAt DateTime? @map("created_at") @db.Timestamp

  user            User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  passwordHistory PasswordHistory[]

  @@index([email])
  @@index([userId])
  @@index([token])
  @@index([createdAt])
  @@index([expiresAt, usedAt])
  @@index([userId, createdAt])
  @@index([usedAt])
  @@map("password_resets")
}

model PersonalAccessToken {
  id                BigInt    @id @default(autoincrement()) @db.BigInt
  tokenableType     String    @map("tokenable_type") @db.VarChar(255)
  tokenableId       BigInt    @map("tokenable_id") @db.BigInt
  name              String    @db.VarChar(255)
  token             String    @unique @db.VarChar(64)
  tokenHash         String?   @unique @map("token_hash") @db.VarChar(64)
  abilities         String?   @db.Text
  lastUsedAt        DateTime? @map("last_used_at") @db.Timestamp
  lastUsedIp        String?   @map("last_used_ip") @db.VarChar(45)
  lastUsedUserAgent String?   @map("last_used_user_agent") @db.VarChar(500)
  expiresAt         DateTime? @map("expires_at") @db.Timestamp
  revokedAt         DateTime? @map("revoked_at") @db.Timestamp
  revokedBy         BigInt?   @map("revoked_by") @db.BigInt
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamp

  user User? @relation(fields: [tokenableId], references: [id], onDelete: SetNull)

  @@index([tokenableType, tokenableId, revokedAt])
  @@index([tokenHash])
  @@index([expiresAt, revokedAt])
  @@map("personal_access_tokens")
}

model PasswordHistory {
  id              BigInt   @id @default(autoincrement()) @db.BigInt
  userId          BigInt   @map("user_id") @db.BigInt
  passwordHash    String   @map("password_hash") @db.VarChar(255)
  passwordResetId BigInt?  @map("password_reset_id") @db.BigInt
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  passwordReset PasswordReset? @relation(fields: [passwordResetId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([passwordResetId])
  @@map("password_history")
}

model UserInvitation {
  id         BigInt    @id @default(autoincrement()) @db.BigInt
  email      String    @db.VarChar(255)
  token      String    @unique @db.VarChar(255)
  tenantId   BigInt?   @map("tenant_id") @db.BigInt
  invitedBy  BigInt    @map("invited_by") @db.BigInt
  role       String?   @default("member") @db.VarChar(50)
  acceptedAt DateTime? @map("accepted_at") @db.Timestamp
  expiresAt  DateTime  @map("expires_at") @db.Timestamp
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamp

  tenant  Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inviter User    @relation("UserInvitations", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([tenantId])
  @@index([invitedBy])
  @@index([expiresAt, acceptedAt])
  @@map("user_invitations")
}

// ========================================
// AUTHORIZATION & PERMISSIONS
// ========================================

model Permission {
  id        BigInt   @id @default(autoincrement()) @db.BigInt
  name      String   @db.VarChar(255)
  guardName String   @map("guard_name") @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp

  userPermissions UserPermission[]
  rolePermissions RolePermission[]

  @@unique([name, guardName])
  @@map("permissions")
}

model Role {
  id        BigInt   @id @default(autoincrement()) @db.BigInt
  name      String   @db.VarChar(255)
  guardName String   @map("guard_name") @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([name, guardName])
  @@map("roles")
}

model UserRole {
  userId    BigInt   @map("user_id") @db.BigInt
  roleId    BigInt   @map("role_id") @db.BigInt
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model UserPermission {
  userId       BigInt   @map("user_id") @db.BigInt
  permissionId BigInt   @map("permission_id") @db.BigInt
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@map("user_permissions")
}

model RolePermission {
  permissionId BigInt   @map("permission_id") @db.BigInt
  roleId       BigInt   @map("role_id") @db.BigInt
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([permissionId, roleId])
  @@map("role_has_permissions")
}

// ========================================
// PROJECTS & REPOSITORIES
// ========================================

model Project {
  id          BigInt   @id @default(autoincrement()) @db.BigInt
  tenantId    BigInt   @map("tenant_id") @db.BigInt
  title       String   @db.VarChar(255)
  description String?  @db.VarChar(500)
  createdBy   BigInt?  @map("created_by") @db.BigInt
  updatedBy   BigInt?  @map("updated_by") @db.BigInt
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp

  tenant                 Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator                User?                  @relation("ProjectCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater                User?                  @relation("ProjectUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  repositories           Repository[]
  testPlans              TestPlan[]
  testExecutionSummaries TestExecutionSummary[]
  bugAnalyticsDaily      BugAnalyticsDaily[]
  testCaseAnalytics      TestCaseAnalytics[]
  testRuns               TestRun[]
  documents              Document[]
  bugBudgets             BugBudget[]
  prdReviews             PrdReview[]
  gitlabMrLeadTimes      GitlabMrLeadTime[]
  gitlabMrContributors   GitlabMrContributor[]
  jiraLeadTimes          JiraLeadTime[]
  monthlyContributions   MonthlyContribution[]

  @@index([tenantId, id])
  @@index([tenantId, createdAt])
  @@index([createdAt])
  @@index([createdBy])
  @@index([title])
  @@map("projects")
}

model Repository {
  id          BigInt   @id @default(autoincrement()) @db.BigInt
  tenantId    BigInt   @map("tenant_id") @db.BigInt
  projectId   BigInt   @map("project_id") @db.BigInt
  title       String   @db.VarChar(255)
  prefix      String   @db.VarChar(50)
  description String?  @db.Text
  createdBy   BigInt?  @map("created_by") @db.BigInt
  updatedBy   BigInt?  @map("updated_by") @db.BigInt
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp

  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project           Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  suites            Suite[]
  testPlans         TestPlan[]
  testRuns          TestRun[]
  testCaseAnalytics TestCaseAnalytics[]

  @@index([tenantId, id])
  @@index([tenantId, projectId])
  @@index([projectId])
  @@index([projectId, createdAt])
  @@index([createdBy])
  @@index([title])
  @@map("repositories")
}

model Setting {
  id          BigInt   @id @default(autoincrement()) @db.BigInt
  key         String   @unique @db.VarChar(255)
  value       String?  @db.Text
  type        String   @default("string") @db.VarChar(50)
  category    String?  @db.VarChar(100)
  description String?  @db.Text
  createdBy   BigInt?  @map("created_by") @db.BigInt
  updatedBy   BigInt?  @map("updated_by") @db.BigInt
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp

  @@index([category])
  @@index([type, category])
  @@index([createdBy])
  @@map("settings")
}

// ========================================
// TEST PLANNING & ORGANIZATION
// ========================================

model Suite {
  id           BigInt   @id @default(autoincrement()) @db.BigInt
  repositoryId BigInt   @map("repository_id") @db.BigInt
  parentId     BigInt?  @map("parent_id") @db.BigInt
  title        String   @db.VarChar(255)
  order        Int?     @db.Integer
  createdBy    BigInt?  @map("created_by") @db.BigInt
  updatedBy    BigInt?  @map("updated_by") @db.BigInt
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp

  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  parent     Suite?     @relation("SuiteHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children   Suite[]    @relation("SuiteHierarchy")
  testCases  TestCase[]

  @@index([repositoryId])
  @@index([parentId])
  @@index([repositoryId, parentId])
  @@index([createdBy])
  @@index([repositoryId, order])
  @@map("suites")
}

enum TestCaseDefectStage {
  pre_development
  development
  post_development
  release_production
}

model TestCase {
  id             BigInt               @id @default(autoincrement()) @db.BigInt
  tenantId       BigInt               @map("tenant_id") @db.BigInt
  suiteId        BigInt               @map("suite_id") @db.BigInt
  title          String               @db.VarChar(255)
  description    String?              @db.Text
  labels         String?              @db.VarChar(255)
  automated      Boolean              @default(false)
  priority       Int                  @default(2) @db.Integer
  data           Json?                @db.Json
  order          Int?                 @db.Integer
  regression     Boolean              @default(true)
  epicLink       String?              @map("epic_link") @db.VarChar(255)
  linkedIssue    String?              @map("linked_issue") @db.VarChar(255)
  jiraKey        String?              @map("jira_key") @db.VarChar(45)
  platform       String?              @db.Text
  releaseVersion String?              @map("release_version") @db.VarChar(100)
  severity       String               @default("Moderate") @db.VarChar(45)
  defectStage    TestCaseDefectStage? @map("defect_stage")
  version        Int                  @default(1) @db.Integer
  createdBy      BigInt?              @map("created_by") @db.BigInt
  updatedBy      BigInt?              @map("updated_by") @db.BigInt
  deletedBy      BigInt?              @map("deleted_by") @db.BigInt
  deletedAt      DateTime?            @map("deleted_at") @db.Timestamp
  createdAt      DateTime             @default(now()) @map("created_at") @db.Timestamp
  updatedAt      DateTime             @updatedAt @map("updated_at") @db.Timestamp

  tenant         Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  suite          Suite               @relation(fields: [suiteId], references: [id], onDelete: Cascade)
  comments       TestCaseComment[]
  testPlanCases  TestPlanTestCase[]
  testRunResults TestRunResult[]
  attachments    TestRunAttachment[]

  @@index([tenantId, id])
  @@index([tenantId, suiteId])
  @@index([suiteId])
  @@index([jiraKey])
  @@index([automated, priority])
  @@index([createdBy, createdAt])
  @@index([deletedAt])
  @@index([defectStage])
  @@index([automated, defectStage])
  @@map("test_cases")
}

model TestPlan {
  id           BigInt   @id @default(autoincrement()) @db.BigInt
  projectId    BigInt   @map("project_id") @db.BigInt
  repositoryId BigInt   @map("repository_id") @db.BigInt
  title        String   @db.VarChar(255)
  description  String?  @db.Text
  status       String   @default("draft") @db.VarChar(50)
  data         String?  @db.Text
  createdBy    BigInt?  @map("created_by") @db.BigInt
  updatedBy    BigInt?  @map("updated_by") @db.BigInt
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp

  project       Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repository    Repository         @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  testPlanCases TestPlanTestCase[]
  testRuns      TestRun[]
  comments      TestRunComment[]

  @@index([projectId, repositoryId])
  @@index([projectId, repositoryId, status])
  @@index([createdBy])
  @@index([title])
  @@index([status])
  @@map("test_plans")
}

model TestPlanTestCase {
  testPlanId BigInt   @map("test_plan_id") @db.BigInt
  testCaseId BigInt   @map("test_case_id") @db.BigInt
  order      Int      @default(0) @db.Integer
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp

  testPlan TestPlan @relation(fields: [testPlanId], references: [id], onDelete: Cascade)
  testCase TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@id([testPlanId, testCaseId])
  @@index([testPlanId, order])
  @@index([testCaseId])
  @@map("test_plan_test_cases")
}

model TestCaseComment {
  id         BigInt    @id @default(autoincrement()) @db.BigInt
  testCaseId BigInt    @map("test_case_id") @db.BigInt
  userId     BigInt    @map("user_id") @db.BigInt
  parentId   BigInt?   @map("parent_id") @db.BigInt
  content    String    @db.Text
  isResolved Boolean   @default(false) @map("is_resolved")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamp
  deletedAt  DateTime? @map("deleted_at") @db.Timestamp

  testCase TestCase          @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  parent   TestCaseComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  TestCaseComment[] @relation("CommentReplies")

  @@index([testCaseId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@index([testCaseId, isResolved, createdAt])
  @@map("test_case_comments")
}

// ========================================
// TEST EXECUTION & RESULTS
// ========================================

enum TestRunStatus {
  pending
  running
  completed
  failed
  cancelled
}

enum TestRunResultStatus {
  passed
  failed
  skipped
  blocked
}

model TestRun {
  id            BigInt        @id @default(autoincrement()) @db.BigInt
  testPlanId    BigInt        @map("test_plan_id") @db.BigInt
  projectId     BigInt        @map("project_id") @db.BigInt
  repositoryId  BigInt?       @map("repository_id") @db.BigInt
  title         String        @db.VarChar(255)
  status        TestRunStatus @default(pending)
  executionDate DateTime?     @map("execution_date") @db.Date
  startedAt     DateTime?     @map("started_at") @db.Timestamp
  completedAt   DateTime?     @map("completed_at") @db.Timestamp
  environment   String?       @db.VarChar(100)
  buildVersion  String?       @map("build_version") @db.VarChar(100)
  data          String?       @db.Text
  createdBy     BigInt?       @map("created_by") @db.BigInt
  updatedBy     BigInt?       @map("updated_by") @db.BigInt
  createdAt     DateTime      @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime      @updatedAt @map("updated_at") @db.Timestamp

  testPlan    TestPlan            @relation(fields: [testPlanId], references: [id], onDelete: Cascade)
  project     Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repository  Repository?         @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  results     TestRunResult[]
  attachments TestRunAttachment[]
  comments    TestRunComment[]

  @@index([projectId, createdAt])
  @@index([testPlanId, createdAt])
  @@index([repositoryId, createdAt])
  @@index([createdBy, createdAt])
  @@index([title])
  @@index([status, executionDate])
  @@index([executionDate])
  @@index([status, startedAt])
  @@index([environment, executionDate])
  @@map("test_runs")
}

model TestRunResult {
  id                 BigInt               @id @default(autoincrement()) @db.BigInt
  testRunId          BigInt               @map("test_run_id") @db.BigInt
  testCaseId         BigInt               @map("test_case_id") @db.BigInt
  status             TestRunResultStatus
  executionTime      Int?                 @map("execution_time") @db.Integer
  errorMessage       String?              @map("error_message") @db.Text
  stackTrace         String?              @map("stack_trace") @db.Text
  screenshots        Json?                @map("screenshots")
  logs               String?              @db.Text
  defectFoundAtStage TestCaseDefectStage? @map("defect_found_at_stage")
  bugBudgetId        BigInt?              @map("bug_budget_id") @db.BigInt
  defectSeverity     String?              @map("defect_severity") @db.VarChar(50)
  executedBy         BigInt?              @map("executed_by") @db.BigInt
  executedAt         DateTime?            @map("executed_at") @db.Timestamp
  retryCount         Int                  @default(0) @map("retry_count") @db.Integer
  createdAt          DateTime             @default(now()) @map("created_at") @db.Timestamp

  testRun   TestRun    @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  testCase  TestCase   @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  bugBudget BugBudget? @relation(fields: [bugBudgetId], references: [id], onDelete: SetNull)

  @@unique([testRunId, testCaseId])
  @@index([testRunId, status])
  @@index([testCaseId, status])
  @@index([executedBy, executedAt])
  @@index([testRunId, executedAt])
  @@index([status, executedAt])
  @@index([defectFoundAtStage, executedAt])
  @@index([bugBudgetId])
  @@index([status, defectFoundAtStage])
  @@map("test_run_results")
}

model TestRunAttachment {
  id         BigInt   @id @default(autoincrement()) @db.BigInt
  url        String   @db.VarChar(500)
  testRunId  BigInt   @map("test_run_id") @db.BigInt
  testCaseId BigInt   @map("test_case_id") @db.BigInt
  uploadedBy BigInt?  @map("uploaded_by") @db.BigInt
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp

  testRun  TestRun  @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  testCase TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@index([testRunId])
  @@index([testCaseId])
  @@index([testRunId, testCaseId])
  @@index([uploadedBy])
  @@map("test_runs_attachments")
}

model TestRunComment {
  id         BigInt   @id @default(autoincrement()) @db.BigInt
  userId     BigInt   @map("user_id") @db.BigInt
  comments   String   @db.Text
  testRunId  BigInt   @map("test_run_id") @db.BigInt
  testPlanId BigInt   @map("test_plan_id") @db.BigInt
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamp

  testRun  TestRun  @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  testPlan TestPlan @relation(fields: [testPlanId], references: [id], onDelete: Cascade)

  @@index([testRunId, createdAt])
  @@index([testPlanId, createdAt])
  @@index([userId, createdAt])
  @@map("test_runs_comments")
}

// ========================================
// DOCUMENT MANAGEMENT
// ========================================

model Document {
  id           BigInt    @id @default(autoincrement()) @db.BigInt
  tenantId     BigInt    @map("tenant_id") @db.BigInt
  projectId    BigInt    @map("project_id") @db.BigInt
  parentId     BigInt?   @map("parent_id") @db.BigInt
  title        String    @db.VarChar(255)
  content      String?   @db.Text
  contentId    BigInt?   @map("content_id") @db.BigInt
  version      Int       @default(1) @db.Integer
  createdBy    BigInt?   @map("created_by") @db.BigInt
  lastEditedBy BigInt?   @map("last_edited_by") @db.BigInt
  deletedBy    BigInt?   @map("deleted_by") @db.BigInt
  viewsCount   Int       @default(0) @map("views_count") @db.Integer
  likesCount   Int       @default(0) @map("likes_count") @db.Integer
  starsCount   Int       @default(0) @map("stars_count") @db.Integer
  deletedAt    DateTime? @map("deleted_at") @db.Timestamp
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamp

  tenant         Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project        Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent         Document?            @relation("DocumentHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children       Document[]           @relation("DocumentHierarchy")
  versions       DocumentVersion[]
  comments       DocumentComment[]
  engagements    DocumentEngagement[]
  contentStorage ContentStorage?      @relation(fields: [contentId], references: [id], onDelete: SetNull)

  @@index([tenantId, id])
  @@index([tenantId, projectId, createdAt])
  @@index([projectId, createdAt])
  @@index([parentId])
  @@index([deletedAt])
  @@index([contentId])
  @@map("documents")
}

model DocumentVersion {
  id            BigInt   @id @default(autoincrement()) @db.BigInt
  documentId    BigInt   @map("document_id") @db.BigInt
  title         String   @db.VarChar(255)
  content       String   @db.Text
  versionNumber Int      @map("version_number") @db.Integer
  createdBy     BigInt?  @map("created_by") @db.BigInt
  changeSummary String?  @map("change_summary") @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamp

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([versionNumber])
  @@index([createdAt])
  @@map("document_versions")
}

enum DocumentEngagementType {
  like
  star
  view
}

model DocumentEngagement {
  id             BigInt                 @id @default(autoincrement()) @db.BigInt
  documentId     BigInt                 @map("document_id") @db.BigInt
  userId         BigInt                 @map("user_id") @db.BigInt
  engagementType DocumentEngagementType @map("engagement_type")
  viewedAt       DateTime?              @map("viewed_at") @db.Timestamp
  createdAt      DateTime               @default(now()) @map("created_at") @db.Timestamp
  updatedAt      DateTime               @updatedAt @map("updated_at") @db.Timestamp

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId, engagementType])
  @@index([documentId])
  @@index([userId])
  @@index([engagementType])
  @@index([viewedAt])
  @@map("document_engagements")
}

model DocumentComment {
  id                BigInt    @id @default(autoincrement()) @db.BigInt
  documentId        BigInt?   @map("document_id") @db.BigInt
  documentManagerId BigInt?   @map("document_manager_id") @db.BigInt
  userId            BigInt    @map("user_id") @db.BigInt
  parentId          BigInt?   @map("parent_id") @db.BigInt
  content           String    @db.Text
  commentType       String    @default("general") @map("comment_type") @db.VarChar(50)
  isResolved        Boolean   @default(false) @map("is_resolved")
  mentionedUserIds  Json?     @map("mentioned_user_ids")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamp
  deletedAt         DateTime? @map("deleted_at") @db.Timestamp

  document Document?         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  parent   DocumentComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  DocumentComment[] @relation("CommentReplies")

  @@index([documentId])
  @@index([documentManagerId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@index([documentId, createdAt])
  @@index([documentManagerId, createdAt])
  @@index([isResolved, createdAt])
  @@map("document_comments")
}

model ContentStorage {
  id             BigInt   @id @default(autoincrement()) @db.BigInt
  contentHash    String   @unique @map("content_hash") @db.VarChar(64)
  contentType    String   @map("content_type") @db.VarChar(50)
  contentSize    BigInt   @map("content_size") @db.BigInt
  storagePath    String?  @map("storage_path") @db.VarChar(500)
  contentData    String?  @map("content_data") @db.Text
  referenceCount Int      @default(0) @map("reference_count") @db.Integer
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamp

  documents Document[]

  @@index([contentHash])
  @@index([contentType, contentSize])
  @@index([referenceCount])
  @@map("content_storage")
}

model DocumentTemplate {
  id        BigInt   @id @default(autoincrement()) @db.BigInt
  name      String   @db.VarChar(255)
  type      String   @db.VarChar(100)
  content   String   @db.Text
  variables Json?    @map("variables")
  isActive  Boolean  @default(true) @map("is_active") @db.Boolean
  createdBy BigInt?  @map("created_by") @db.BigInt
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp

  creator User? @relation("DocumentTemplateCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([type, isActive])
  @@index([createdBy])
  @@index([name])
  @@map("document_templates")
}

model EditorImage {
  id           BigInt   @id @default(autoincrement()) @db.BigInt
  filename     String   @db.VarChar(255)
  originalName String   @map("original_name") @db.VarChar(255)
  path         String   @db.VarChar(500)
  mimeType     String   @map("mime_type") @db.VarChar(100)
  size         Int      @db.Integer
  uploadedBy   BigInt?  @map("uploaded_by") @db.BigInt
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp

  uploader User? @relation("EditorImageUploader", fields: [uploadedBy], references: [id], onDelete: SetNull)

  @@index([uploadedBy, createdAt])
  @@index([mimeType])
  @@index([filename])
  @@map("editor_images")
}

// ========================================
// ANALYTICS SUMMARY TABLES
// ========================================

model TestExecutionSummary {
  id               BigInt   @id @default(autoincrement()) @db.BigInt
  projectId        BigInt   @map("project_id") @db.BigInt
  date             DateTime @db.Date
  totalRuns        Int      @default(0) @map("total_runs") @db.Integer
  passedRuns       Int      @default(0) @map("passed_runs") @db.Integer
  failedRuns       Int      @default(0) @map("failed_runs") @db.Integer
  skippedRuns      Int      @default(0) @map("skipped_runs") @db.Integer
  blockedRuns      Int      @default(0) @map("blocked_runs") @db.Integer
  automatedCount   Int      @default(0) @map("automated_count") @db.Integer
  manualCount      Int      @default(0) @map("manual_count") @db.Integer
  avgExecutionTime Decimal? @map("avg_execution_time") @db.Decimal(10, 2)
  totalTestCases   Int      @default(0) @map("total_test_cases") @db.Integer
  lastUpdatedAt    DateTime @map("last_updated_at") @db.Timestamp

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, date])
  @@index([date])
  @@index([projectId, date, lastUpdatedAt])
  @@map("test_execution_summary")
}

model BugAnalyticsDaily {
  id                 BigInt   @id @default(autoincrement()) @db.BigInt
  project            String   @db.VarChar(255)
  projectId          BigInt?  @map("project_id") @db.BigInt
  date               DateTime @db.Date
  bugsCreated        Int      @default(0) @map("bugs_created") @db.Integer
  bugsResolved       Int      @default(0) @map("bugs_resolved") @db.Integer
  bugsClosed         Int      @default(0) @map("bugs_closed") @db.Integer
  bugsReopened       Int      @default(0) @map("bugs_reopened") @db.Integer
  avgResolutionHours Decimal? @map("avg_resolution_hours") @db.Decimal(10, 2)
  openBugs           Int      @default(0) @map("open_bugs") @db.Integer
  criticalBugs       Int      @default(0) @map("critical_bugs") @db.Integer
  highPriorityBugs   Int      @default(0) @map("high_priority_bugs") @db.Integer
  mediumPriorityBugs Int      @default(0) @map("medium_priority_bugs") @db.Integer
  lowPriorityBugs    Int      @default(0) @map("low_priority_bugs") @db.Integer
  lastUpdatedAt      DateTime @map("last_updated_at") @db.Timestamp

  projectRef Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([project, date])
  @@unique([projectId, date])
  @@index([date])
  @@index([project, date, lastUpdatedAt])
  @@index([projectId, date, lastUpdatedAt])
  @@map("bug_analytics_daily")
}

model TestCaseAnalytics {
  id                  BigInt   @id @default(autoincrement()) @db.BigInt
  projectId           BigInt   @map("project_id") @db.BigInt
  repositoryId        BigInt   @map("repository_id") @db.BigInt
  date                DateTime @db.Date
  totalCases          Int      @default(0) @map("total_cases") @db.Integer
  automatedCases      Int      @default(0) @map("automated_cases") @db.Integer
  manualCases         Int      @default(0) @map("manual_cases") @db.Integer
  highPriorityCases   Int      @default(0) @map("high_priority_cases") @db.Integer
  mediumPriorityCases Int      @default(0) @map("medium_priority_cases") @db.Integer
  lowPriorityCases    Int      @default(0) @map("low_priority_cases") @db.Integer
  regressionCases     Int      @default(0) @map("regression_cases") @db.Integer
  lastUpdatedAt       DateTime @map("last_updated_at") @db.Timestamp

  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@unique([projectId, repositoryId, date])
  @@index([date])
  @@index([projectId, date])
  @@map("test_case_analytics")
}

// ========================================
// SYSTEM CONFIGURATION
// ========================================

model MenuVisibility {
  id        BigInt   @id @default(autoincrement()) @db.BigInt
  menuKey   String   @unique @map("menu_key") @db.VarChar(255)
  menuName  String   @map("menu_name") @db.VarChar(255)
  isVisible Boolean  @default(true) @map("is_visible") @db.Boolean
  parentKey String?  @map("parent_key") @db.VarChar(255)
  sortOrder Int?     @map("sort_order") @db.Integer
  metadata  Json?    @map("metadata")
  createdBy BigInt?  @map("created_by") @db.BigInt
  updatedBy BigInt?  @map("updated_by") @db.BigInt
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp

  creator User? @relation("MenuVisibilityCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater User? @relation("MenuVisibilityUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)

  @@index([parentKey, sortOrder])
  @@index([isVisible])
  @@map("menu_visibilities")
}

model Notification {
  id             String    @id @default(uuid()) @db.Uuid
  type           String    @db.VarChar(255)
  notifiableType String    @map("notifiable_type") @db.VarChar(255)
  notifiableId   BigInt    @map("notifiable_id") @db.BigInt
  data           String    @db.Text
  readAt         DateTime? @map("read_at") @db.Timestamp
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamp

  @@index([notifiableType, notifiableId, readAt, createdAt])
  @@index([notifiableType, notifiableId, type])
  @@map("notifications")
}

// ========================================
// CQRS READ MODELS
// ========================================

model TestRunsView {
  id                BigInt    @id @db.BigInt
  testPlanId        BigInt    @map("test_plan_id") @db.BigInt
  testPlanTitle     String    @map("test_plan_title") @db.VarChar(255)
  projectId         BigInt    @map("project_id") @db.BigInt
  projectTitle      String    @map("project_title") @db.VarChar(255)
  repositoryId      BigInt    @map("repository_id") @db.BigInt
  repositoryTitle   String    @map("repository_title") @db.VarChar(255)
  title             String    @db.VarChar(255)
  totalCases        Int       @default(0) @map("total_cases") @db.Integer
  passedCases       Int       @default(0) @map("passed_cases") @db.Integer
  failedCases       Int       @default(0) @map("failed_cases") @db.Integer
  skippedCases      Int       @default(0) @map("skipped_cases") @db.Integer
  blockedCases      Int       @default(0) @map("blocked_cases") @db.Integer
  executionDate     DateTime? @map("execution_date") @db.Date
  executionDuration Int?      @map("execution_duration") @db.Integer
  createdById       BigInt?   @map("created_by_id") @db.BigInt
  createdByName     String?   @map("created_by_name") @db.VarChar(255)
  lastUpdatedAt     DateTime  @map("last_updated_at") @db.Timestamp

  @@index([projectId, executionDate])
  @@index([testPlanId, executionDate])
  @@index([repositoryId, executionDate])
  @@index([executionDate])
  @@index([createdById])
  @@map("test_runs_view")
}

// ========================================
// BUG TRACKING & ISSUE MANAGEMENT
// ========================================

model BugBudget {
  id             BigInt    @id @default(autoincrement()) @db.BigInt
  jiraKey        String    @unique @map("jira_key") @db.VarChar(255)
  project        String    @db.VarChar(255)
  projectId      BigInt?   @map("project_id") @db.BigInt
  summary        String    @db.Text
  status         String?   @db.VarChar(255)
  issueType      String?   @map("issue_type") @db.VarChar(255)
  finalIssueType String?   @map("final_issue_type") @db.VarChar(255)
  priority       String?   @db.VarChar(255)
  severityIssue  String?   @map("severity_issue") @db.VarChar(255)
  sprint         String?   @db.VarChar(255)
  statusCategory String?   @map("status_category") @db.VarChar(255)
  assigneeFinal  String?   @map("assignee_final") @db.VarChar(255)
  assigneeId     BigInt?   @map("assignee_id") @db.BigInt
  reporter       String?   @db.VarChar(255)
  reporterId     BigInt?   @map("reporter_id") @db.BigInt
  creator        String?   @db.VarChar(255)
  creatorId      BigInt?   @map("creator_id") @db.BigInt
  labels         String?   @db.Text
  isOpen         Boolean   @default(true) @map("is_open") @db.Boolean
  createdDate    DateTime? @map("created_date") @db.Timestamp
  updatedDate    DateTime? @map("updated_date") @db.Timestamp
  resolvedDate   DateTime? @map("resolved_date") @db.Timestamp
  dueDate        DateTime? @map("due_date") @db.Timestamp
  lastSyncedAt   DateTime? @map("last_synced_at") @db.Timestamp
  description    String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamp

  projectRef     Project?           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assigneeUser   User?              @relation("BugBudgetAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  reporterUser   User?              @relation("BugBudgetReporter", fields: [reporterId], references: [id], onDelete: SetNull)
  creatorUser    User?              @relation("BugBudgetCreator", fields: [creatorId], references: [id], onDelete: SetNull)
  metadata       BugBudgetMetadata?
  testRunResults TestRunResult[]
  jiraLeadTimes  JiraLeadTime[]

  @@index([project, status, isOpen])
  @@index([projectId, status, isOpen])
  @@index([assigneeFinal, status])
  @@index([assigneeId, status])
  @@index([sprint, statusCategory])
  @@index([createdDate, resolvedDate])
  @@index([jiraKey, lastSyncedAt])
  @@index([projectId])
  @@map("bug_budget")
}

model BugBudgetMetadata {
  bugBudgetId          BigInt   @id @map("bug_budget_id") @db.BigInt
  epicHierarchy        Json?    @map("epic_hierarchy")
  assigneeDetails      Json?    @map("assignee_details")
  dateFields           Json?    @map("date_fields")
  analysisFields       Json?    @map("analysis_fields")
  classificationFields Json?    @map("classification_fields")
  reportFields         Json?    @map("report_fields")
  storyPointsData      Json?    @map("story_points_data")
  versionFields        Json?    @map("version_fields")
  rawJiraData          Json?    @map("raw_jira_data")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamp

  bugBudget BugBudget @relation(fields: [bugBudgetId], references: [id], onDelete: Cascade)

  @@map("bug_budget_metadata")
}

model JiraTableHistory {
  id                         BigInt    @id @default(autoincrement()) @db.BigInt
  project                    String?   @db.VarChar(255)
  issuetype                  String?   @db.VarChar(255)
  issuekey                   String    @unique @db.VarChar(255)
  summary                    String?   @db.Text
  description                String?   @db.Text
  acceptanceCriteria         String?   @map("acceptance_criteria") @db.Text
  implementationDetail       String?   @map("implementation_detail") @db.Text
  components                 Json?     @map("components")
  epicLink                   String?   @map("epic_link") @db.VarChar(255)
  epicName                   String?   @map("epic_name") @db.VarChar(255)
  epicStatus                 String?   @map("epic_status") @db.VarChar(255)
  fixVersions                Json?     @map("fix_versions")
  priority                   String?   @db.VarChar(255)
  severityIssue              String?   @map("severity_issue") @db.VarChar(255)
  comment                    Json?     @map("comment")
  subtasks                   Json?     @map("subtasks")
  parent                     String?   @db.VarChar(255)
  parentLink                 String?   @map("parent_link") @db.VarChar(255)
  labels                     Json?     @map("labels")
  linkedIssues               Json?     @map("linked_issues")
  linkedItems                Json?     @map("linked_items")
  linkedTestDocument         String?   @map("linked_test_document") @db.VarChar(255)
  testRunLink                String?   @map("test_run_link") @db.VarChar(255)
  userJourney                String?   @map("user_journey") @db.VarChar(255)
  serviceFeature             String?   @map("service_feature") @db.VarChar(255)
  created                    DateTime? @map("created") @db.Timestamp
  beginDate                  DateTime? @map("begin_date") @db.Timestamp
  startDate                  DateTime? @map("start_date") @db.Date
  actualStart                DateTime? @map("actual_start") @db.Timestamp
  dueDate                    DateTime? @map("due_date") @db.Date
  endDate                    DateTime? @map("end_date") @db.Timestamp
  actualEnd                  DateTime? @map("actual_end") @db.Timestamp
  sprint                     String?   @db.VarChar(255)
  sprintId                   BigInt?   @map("sprint_id") @db.BigInt
  sprintState                String?   @map("sprint_state") @db.VarChar(255)
  sprintCompleteDate         DateTime? @map("sprint_complete_date") @db.Timestamp
  sprintStartDate            DateTime? @map("sprint_start_date") @db.Timestamp
  sprintEndDate              DateTime? @map("sprint_end_date") @db.Timestamp
  sprintGoalId               BigInt?   @map("sprint_goal_id") @db.BigInt
  status                     String?   @db.VarChar(255)
  statusCategory             String?   @map("status_category") @db.VarChar(255)
  statusCategoryChanged      DateTime? @map("status_category_changed") @db.Timestamp
  owner                      String?   @db.VarChar(255)
  approvers                  Json?     @map("approvers")
  assignee                   String?   @db.VarChar(255)
  engineerAssignee           Json?     @map("engineer_assignee")
  collaborators              Json?     @map("collaborators")
  testerAssignee             String?   @map("tester_assignee") @db.VarChar(255)
  reporter                   String?   @db.VarChar(255)
  storyPoints                Decimal?  @map("story_points") @db.Decimal(10, 2)
  storyPointEstimate         Decimal?  @map("story_point_estimate") @db.Decimal(10, 2)
  reTestPoint                Decimal?  @map("re_test_point") @db.Decimal(10, 2)
  logWork                    Json?     @map("log_work")
  originalEstimate           Int?      @map("original_estimate") @db.Integer
  timeSpent                  Int?      @map("time_spent") @db.Integer
  timeTracking               Json?     @map("time_tracking")
  timeToFirstResponse        String?   @map("time_to_first_response") @db.VarChar(255)
  timeToResolution           String?   @map("time_to_resolution") @db.VarChar(255)
  timeToCloseAfterResolution String?   @map("time_to_close_after_resolution") @db.VarChar(255)
  tisAlBoard                 String?   @map("tis_al_board") @db.VarChar(255)
  chartDateOfFirstResponse   DateTime? @map("chart_date_of_first_response") @db.Timestamp
  chartTimeInStatus          Json?     @map("chart_time_in_status")
  updated                    DateTime? @map("updated") @db.Timestamp
  resolution                 String?   @db.VarChar(255)
  resolved                   DateTime? @map("resolved") @db.Timestamp
  rawJiraData                Json?     @map("raw_jira_data")
  syncedAt                   DateTime? @map("synced_at") @db.Timestamp
  syncSource                 String?   @map("sync_source") @db.VarChar(255)
  jqlQueryUsed               String?   @map("jql_query_used") @db.Text
  createdAt                  DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt                  DateTime  @updatedAt @map("updated_at") @db.Timestamp

  @@index([project])
  @@index([issuetype])
  @@index([issuekey])
  @@index([epicLink])
  @@index([priority])
  @@index([created])
  @@index([updated])
  @@index([status])
  @@index([assignee])
  @@index([reporter])
  @@index([sprint])
  @@index([sprintId])
  @@index([syncedAt])
  @@index([project, issuetype])
  @@index([status, created])
  @@index([assignee, status])
  @@index([created, resolved])
  @@index([sprintState, sprintCompleteDate])
  @@index([sprintCompleteDate])
  @@map("jira_table_history")
}

model JiraField {
  id          BigInt    @id @default(autoincrement()) @db.BigInt
  fieldType   String    @map("field_type") @db.VarChar(255)
  fieldId     String    @unique @map("field_id") @db.VarChar(255)
  description String?   @db.Text
  isCustom    Boolean   @default(false) @map("is_custom") @db.Boolean
  isActive    Boolean   @default(true) @map("is_active") @db.Boolean
  sortOrder   Int       @default(0) @map("sort_order") @db.Integer
  createdBy   BigInt?   @map("created_by") @db.BigInt
  updatedBy   BigInt?   @map("updated_by") @db.BigInt
  createdAt   DateTime? @map("created_at") @db.Timestamp
  updatedAt   DateTime? @updatedAt @map("updated_at") @db.Timestamp

  creator User? @relation("JiraFieldCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater User? @relation("JiraFieldUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)

  @@index([fieldId])
  @@index([isCustom])
  @@index([isActive])
  @@index([fieldType, isActive])
  @@index([createdBy])
  @@map("jira_fields")
}

// ========================================
// ARCHIVE TABLES
// ========================================

model AuditLogsArchive {
  id                BigInt   @id @default(autoincrement()) @db.BigInt
  userId            BigInt?  @map("user_id") @db.BigInt
  action            String   @db.VarChar(255)
  modelType         String?  @map("model_type") @db.VarChar(255)
  modelId           BigInt?  @map("model_id") @db.BigInt
  oldValues         Json?    @map("old_values")
  newValues         Json?    @map("new_values")
  ipAddress         String?  @map("ip_address") @db.VarChar(45)
  userAgent         String?  @map("user_agent") @db.VarChar(500)
  archivedAt        DateTime @map("archived_at") @db.Timestamp
  originalCreatedAt DateTime @map("original_created_at") @db.Timestamp
  originalUpdatedAt DateTime @map("original_updated_at") @db.Timestamp

  @@index([modelType, modelId, originalCreatedAt])
  @@index([userId, originalCreatedAt])
  @@index([action, originalCreatedAt])
  @@map("audit_logs_archive")
}

model JiraTableHistoryArchive {
  id                BigInt    @id @default(autoincrement()) @db.BigInt
  issuekey          String    @db.VarChar(255)
  project           String?   @db.VarChar(255)
  issuetype         String?   @db.VarChar(255)
  summary           String?   @db.Text
  description       String?   @db.Text
  rawJiraData       Json?     @map("raw_jira_data")
  syncedAt          DateTime? @map("synced_at") @db.Timestamp
  archivedAt        DateTime  @map("archived_at") @db.Timestamp
  originalCreatedAt DateTime  @map("original_created_at") @db.Timestamp
  originalUpdatedAt DateTime  @map("original_updated_at") @db.Timestamp

  @@index([project])
  @@index([issuetype])
  @@index([issuekey])
  @@map("jira_table_history_archive")
}

// ========================================
// AUDIT & LOGGING
// ========================================

model AuditLog {
  id        BigInt   @id @default(autoincrement()) @db.BigInt
  userId    BigInt?  @map("user_id") @db.BigInt
  action    String   @db.VarChar(255)
  modelType String?  @map("model_type") @db.VarChar(255)
  modelId   BigInt?  @map("model_id") @db.BigInt
  oldValues Json?    @map("old_values")
  newValues Json?    @map("new_values")
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([modelType, modelId, createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

// ========================================
// DECISION LOGGING
// ========================================
// Tracks decisions, context, and impact/risk analysis

model DecisionLog {
  id               BigInt   @id @default(autoincrement()) @db.BigInt
  title            String   @db.VarChar(255)
  decisionType     String   @map("decision_type") @db.VarChar(255)
  decisionOwner    String?  @map("decision_owner") @db.VarChar(255)
  decisionOwnerId  BigInt?  @map("decision_owner_id") @db.BigInt
  involvedQa       String?  @map("involved_qa") @db.Text
  decisionDate     DateTime @map("decision_date") @db.Date
  sprintRelease    String?  @map("sprint_release") @db.VarChar(255)
  context          String?  @db.Text
  decision         String   @db.Text
  impactRisk       String?  @map("impact_risk") @db.Text
  status           String   @default("active") @db.VarChar(50)
  tags             Json?    @map("tags")
  relatedArtifacts String?  @map("related_artifacts") @db.Text
  createdBy        BigInt?  @map("created_by") @db.BigInt
  updatedBy        BigInt?  @map("updated_by") @db.BigInt
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamp

  owner   User? @relation("DecisionLogOwner", fields: [decisionOwnerId], references: [id], onDelete: SetNull)
  creator User? @relation("DecisionLogCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater User? @relation("DecisionLogUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)

  @@index([decisionType, status])
  @@index([decisionDate])
  @@index([status, decisionDate])
  @@index([decisionOwner])
  @@index([decisionOwnerId])
  @@index([createdBy])
  @@map("decision_logs")
}

// ========================================
// METADATA & EXTENSIBILITY
// ========================================
// Generic metadata table for custom fields, tags, labels without schema changes

model EntityMetadata {
  id         BigInt   @id @default(autoincrement()) @db.BigInt
  entityType String   @map("entity_type") @db.VarChar(255)
  entityId   BigInt   @map("entity_id") @db.BigInt
  metaKey    String   @map("meta_key") @db.VarChar(255)
  metaValue  String   @map("meta_value") @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamp

  @@unique([entityType, entityId, metaKey])
  @@index([entityType, entityId])
  @@index([metaKey, metaValue])
  @@map("entity_metadata")
}

// ========================================
// PRD REVIEW & REQUIREMENTS
// ========================================
// Product Requirements Document review management

model PrdReview {
  id            BigInt    @id @default(autoincrement()) @db.BigInt
  requestId     String    @unique @map("request_id") @db.VarChar(255) // Format: REV-{unique_id}
  title         String    @db.VarChar(500)
  content       String    @db.Text
  requesterName String    @map("requester_name") @db.VarChar(255)
  confluenceUrl String?   @map("confluence_url") @db.VarChar(2048)
  pageId        String?   @map("page_id") @db.VarChar(255) // Confluence page ID
  aiReview      String?   @map("ai_review") @db.Text // AI-generated review content
  status        String    @default("DRAFT") @db.VarChar(50) // DRAFT, PROCESSING, COMPLETED, FINALIZED
  projectId     BigInt?   @map("project_id") @db.BigInt
  reviewedBy    BigInt?   @map("reviewed_by") @db.BigInt
  reviewedAt    DateTime? @map("reviewed_at") @db.Timestamp
  syncedAt      DateTime? @map("synced_at") @db.Timestamp // Last sync from Google Sheets
  comments      String?   @db.Text
  metadata      Json?     @map("metadata") // Additional metadata (status changes, etc.)
  createdBy     BigInt?   @map("created_by") @db.BigInt
  updatedBy     BigInt?   @map("updated_by") @db.BigInt
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamp

  project  Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  reviewer User?            @relation("PrdReviewReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)
  creator  User?            @relation("PrdReviewCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater  User?            @relation("PrdReviewUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  cache    PrdReviewCache[]

  @@index([requestId])
  @@index([projectId, status])
  @@index([status, createdAt])
  @@index([status, reviewedAt])
  @@index([reviewedBy, reviewedAt])
  @@index([createdBy])
  @@index([requesterName])
  @@index([title])
  @@index([syncedAt])
  @@map("prd_reviews")
}

model PrdReviewCache {
  id          BigInt   @id @default(autoincrement()) @db.BigInt
  prdReviewId BigInt?  @map("prd_review_id") @db.BigInt
  cacheKey    String   @unique @map("cache_key") @db.VarChar(255)
  cacheType   String?  @map("cache_type") @db.VarChar(100)
  data        Json     @map("data")
  expiresAt   DateTime @map("expires_at") @db.Timestamp
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp

  prdReview PrdReview? @relation(fields: [prdReviewId], references: [id], onDelete: Cascade)

  @@index([prdReviewId])
  @@index([cacheKey])
  @@index([expiresAt])
  @@index([cacheKey, expiresAt])
  @@index([prdReviewId, cacheType])
  @@index([cacheType, expiresAt])
  @@map("prd_review_cache")
}

// ========================================
// ANALYTICS & REPORTING (EXTERNAL INTEGRATIONS)
// ========================================
// Allure test reports, GitLab metrics, Jira lead times, monthly contributions

model AllureReport {
  id                 BigInt    @id @default(autoincrement()) @db.BigInt
  name               String    @db.VarChar(255)
  version            String?   @db.VarChar(255)
  summary            Json?     @map("summary")
  status             String    @default("pending") @db.VarChar(50)
  executionStartedAt DateTime? @map("execution_started_at") @db.Timestamp
  executionStoppedAt DateTime? @map("execution_stopped_at") @db.Timestamp
  createdBy          BigInt?   @map("created_by") @db.BigInt
  updatedBy          BigInt?   @map("updated_by") @db.BigInt
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamp

  creator   User?            @relation("AllureReportCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater   User?            @relation("AllureReportUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  scenarios AllureScenario[]

  @@index([status, createdAt])
  @@index([executionStartedAt])
  @@index([name, version])
  @@index([createdBy])
  @@map("allure_report")
}

model AllureScenario {
  id             BigInt   @id @default(autoincrement()) @db.BigInt
  allureReportId BigInt   @map("allure_report_id") @db.BigInt
  name           String   @db.VarChar(255)
  status         String   @db.VarChar(50)
  duration       Int?     @db.Integer
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamp

  report AllureReport @relation(fields: [allureReportId], references: [id], onDelete: Cascade)
  steps  AllureStep[]

  @@index([allureReportId])
  @@index([allureReportId, status])
  @@index([status, duration])
  @@map("allure_scenarios")
}

model AllureStep {
  id           BigInt   @id @default(autoincrement()) @db.BigInt
  scenarioId   BigInt   @map("scenario_id") @db.BigInt
  name         String   @db.VarChar(255)
  status       String   @db.VarChar(50)
  duration     Int?     @db.Integer
  errorMessage String?  @map("error_message") @db.Text
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp

  scenario AllureScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@index([scenarioId, status])
  @@index([status, duration])
  @@map("allure_steps")
}

model GitlabMrLeadTime {
  id            BigInt    @id @default(autoincrement()) @db.BigInt
  projectName   String    @map("project_name") @db.VarChar(255)
  projectId     BigInt?   @map("project_id") @db.BigInt
  mrId          String    @map("mr_id") @db.VarChar(255)
  title         String    @db.VarChar(500)
  author        String    @db.VarChar(255)
  authorId      BigInt?   @map("author_id") @db.BigInt
  mrCreatedAt   DateTime  @map("mr_created_at") @db.Timestamp
  mergedAt      DateTime? @map("merged_at") @db.Timestamp
  leadTimeHours Int?      @map("lead_time_hours") @db.Integer
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamp

  project    Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  authorUser User?    @relation("GitlabMrAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([projectName, mrCreatedAt])
  @@index([projectId, mrCreatedAt])
  @@index([author, mrCreatedAt])
  @@index([authorId, mrCreatedAt])
  @@index([mergedAt])
  @@index([projectName, author])
  @@index([projectId, authorId])
  @@map("gitlab_mr_lead_times")
}

model GitlabMrContributor {
  id            BigInt   @id @default(autoincrement()) @db.BigInt
  projectName   String   @map("project_name") @db.VarChar(255)
  projectId     BigInt?  @map("project_id") @db.BigInt
  username      String   @db.VarChar(255)
  userId        BigInt?  @map("user_id") @db.BigInt
  name          String?  @db.VarChar(255)
  email         String?  @db.VarChar(255)
  contributions Int      @default(0) @db.Integer
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamp

  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  user    User?    @relation("GitlabMrContributor", fields: [userId], references: [id], onDelete: SetNull)

  @@unique([projectName, username])
  @@unique([projectId, userId])
  @@index([projectName, contributions])
  @@index([projectId, contributions])
  @@index([username])
  @@index([userId])
  @@map("gitlab_mr_contributors")
}

model JiraLeadTime {
  id             BigInt    @id @default(autoincrement()) @db.BigInt
  projectKey     String    @map("project_key") @db.VarChar(255)
  projectId      BigInt?   @map("project_id") @db.BigInt
  issueKey       String    @unique @map("issue_key") @db.VarChar(255)
  bugBudgetId    BigInt?   @map("bug_budget_id") @db.BigInt
  issueType      String    @map("issue_type") @db.VarChar(255)
  status         String    @db.VarChar(255)
  issueCreatedAt DateTime  @map("issue_created_at") @db.Timestamp
  resolvedAt     DateTime? @map("resolved_at") @db.Timestamp
  leadTimeHours  Int?      @map("lead_time_hours") @db.Integer
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamp

  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  bugBudget BugBudget? @relation(fields: [bugBudgetId], references: [id], onDelete: SetNull)

  @@index([projectKey, issueCreatedAt])
  @@index([projectId, issueCreatedAt])
  @@index([issueKey])
  @@index([bugBudgetId])
  @@index([status, resolvedAt])
  @@index([projectKey, status])
  @@index([projectId, status])
  @@index([issueType, status])
  @@map("jira_lead_times")
}

model MonthlyContribution {
  id          BigInt   @id @default(autoincrement()) @db.BigInt
  year        Int      @db.Integer
  month       Int      @db.Integer
  monthName   String?  @map("month_name") @db.VarChar(50)
  username    String?  @map("username") @db.VarChar(255)
  userId      BigInt?  @map("user_id") @db.BigInt
  name        String?  @db.VarChar(255)
  squad       String?  @db.VarChar(255)
  mrCreated   Int      @default(0) @map("mr_created") @db.Integer
  mrApproved  Int      @default(0) @map("mr_approved") @db.Integer
  repoPushes  Int      @default(0) @map("repo_pushes") @db.Integer
  totalEvents Int      @default(0) @map("total_events") @db.Integer
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp

  user      User?    @relation("MonthlyContributionUser", fields: [userId], references: [id], onDelete: SetNull)
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectId BigInt?  @map("project_id") @db.BigInt

  @@unique([year, month, username])
  @@unique([year, month, userId])
  @@index([year, month])
  @@index([username, year, month])
  @@index([userId, year, month])
  @@index([squad, year, month])
  @@map("monthly_contributions")
}

// ========================================
// CHANGE DATA CAPTURE (CDC)
// ========================================
// Tracks all database changes for real-time sync and replication

enum ChangeType {
  insert
  update
  delete
}

model ChangeLog {
  id            BigInt     @id @default(autoincrement()) @db.BigInt
  tableName     String     @map("table_name") @db.VarChar(255)
  recordId      BigInt     @map("record_id") @db.BigInt
  changeType    ChangeType @map("change_type")
  oldValues     Json?      @map("old_values")
  newValues     Json?      @map("new_values")
  changedAt     DateTime   @default(now()) @map("changed_at") @db.Timestamp
  changedBy     BigInt?    @map("changed_by") @db.BigInt
  transactionId String?    @map("transaction_id") @db.VarChar(255)
  source        String?    @db.VarChar(100)

  changer User? @relation("ChangeLogChanger", fields: [changedBy], references: [id], onDelete: SetNull)

  @@index([tableName, recordId, changedAt])
  @@index([changedAt])
  @@index([changeType, changedAt])
  @@index([transactionId])
  @@index([tableName, changeType, changedAt])
  @@map("change_log")
}

// ========================================
// AUDIT EVENTS (EVENT SOURCING)
// ========================================
// Event sourcing table for comprehensive audit trail
// Stores all events as immutable append-only log
// Enables time-travel queries, event replay, and complete audit history

model AuditEvent {
  id            BigInt   @id @default(autoincrement()) @db.BigInt
  eventType     String   @map("event_type") @db.VarChar(255)
  aggregateType String   @map("aggregate_type") @db.VarChar(255)
  aggregateId   BigInt   @map("aggregate_id") @db.BigInt
  userId        BigInt?  @map("user_id") @db.BigInt
  eventData     Json     @map("event_data")
  metadata      Json?    @map("metadata")
  occurredAt    DateTime @default(now()) @map("occurred_at") @db.Timestamp

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([aggregateType, aggregateId, occurredAt])
  @@index([userId, occurredAt])
  @@index([eventType, occurredAt])
  @@index([aggregateType, eventType, occurredAt])
  @@map("audit_events")
}

// ========================================
// WORKFLOW & SAGA PATTERNS
// ========================================
// Workflow orchestration for complex multi-step processes

enum SagaStatus {
  pending
  in_progress
  completed
  failed
  rolled_back
}

model WorkflowSaga {
  id           BigInt     @id @default(autoincrement()) @db.BigInt
  sagaType     String     @map("saga_type") @db.VarChar(255)
  currentStep  String     @map("current_step") @db.VarChar(255)
  status       SagaStatus
  context      Json       @map("context")
  startedBy    BigInt?    @map("started_by") @db.BigInt
  completedAt  DateTime?  @map("completed_at") @db.Timestamp
  failedAt     DateTime?  @map("failed_at") @db.Timestamp
  errorMessage String?    @map("error_message") @db.Text
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime   @updatedAt @map("updated_at") @db.Timestamp

  starter User? @relation("WorkflowSagaStarter", fields: [startedBy], references: [id], onDelete: SetNull)

  @@index([sagaType, status])
  @@index([startedBy, status])
  @@index([status, createdAt])
  @@map("workflow_sagas")
}

// ========================================
// CQRS READ MODELS (ADDITIONAL)
// ========================================
// Denormalized bug budget view for fast queries

model BugBudgetView {
  id                  BigInt    @id @map("id") @db.BigInt
  jiraKey             String    @map("jira_key") @db.VarChar(255)
  project             String    @db.VarChar(255)
  projectId           BigInt?   @map("project_id") @db.BigInt
  summary             String    @db.Text
  status              String    @db.VarChar(255)
  issueType           String    @map("issue_type") @db.VarChar(255)
  priority            String?   @db.VarChar(255)
  assigneeFinal       String?   @map("assignee_final") @db.VarChar(255)
  assigneeId          BigInt?   @map("assignee_id") @db.BigInt
  sprint              String?   @db.VarChar(255)
  statusCategory      String?   @map("status_category") @db.VarChar(255)
  isOpen              Boolean   @map("is_open") @db.Boolean
  createdDate         DateTime? @map("created_date") @db.Timestamp
  resolvedDate        DateTime? @map("resolved_date") @db.Timestamp
  epicName            String?   @map("epic_name") @db.VarChar(255)
  serviceFeature      String?   @map("service_feature") @db.VarChar(255)
  resolutionTimeHours Decimal?  @map("resolution_time_hours") @db.Decimal(10, 2)
  ageDays             Int?      @map("age_days") @db.Integer
  lastUpdatedAt       DateTime  @updatedAt @map("last_updated_at") @db.Timestamp

  @@index([project, status, isOpen])
  @@index([projectId, status, isOpen])
  @@index([assigneeFinal, status])
  @@index([assigneeId, status])
  @@index([sprint, statusCategory])
  @@index([createdDate, resolvedDate])
  @@index([epicName])
  @@index([serviceFeature])
  @@map("bug_budget_view")
}

// Note: Additional tables like DocumentTemplate, EditorImage, etc. can be added as needed
